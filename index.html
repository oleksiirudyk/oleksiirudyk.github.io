<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–í–µ—Å—ñ–ª—å–Ω–µ —Ñ–æ—Ç–æ-–±—ñ–Ω–≥–æ</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="flower-decoration flower-top-left"></div>
    <div class="flower-decoration flower-bottom-right"></div>
    
    <div class="container">
        <div class="title">–í–µ—Å—ñ–ª—å–Ω–µ<br>—Ñ–æ—Ç–æ-–ø–æ–ª—é–≤–∞–Ω–Ω—è</div>
        <div class="subtitle">–ó–Ω–∞–π–¥–∏ —Ç–∞ —Å—Ñ–æ—Ç–æ–≥—Ä–∞—Ñ—É–π!</div>
        
        <div id="loading" class="loading">
            –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∑–∞–≤–¥–∞–Ω—å...
        </div>
        
        <div id="error" class="error" style="display: none;">
            –ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∑–∞–≤–¥–∞–Ω—å
        </div>
        
        <div id="bingo-container" style="display: none;">
            <div class="bingo-grid" id="bingoGrid">
                <!-- –ö–ª—ñ—Ç–∏–Ω–∫–∏ –±—É–¥—É—Ç—å –∑–≥–µ–Ω–µ—Ä–æ–≤–∞–Ω—ñ –¥–∏–Ω–∞–º—ñ—á–Ω–æ -->
            </div>
        </div>
    </div>
    
    <!-- –ú–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ -->
    <div id="modal" class="modal">
        <div class="modal-content">
            <div class="modal-title" id="modalTitle"></div>
            <div class="modal-description" id="modalDescription"></div>
            <div class="modal-buttons">
                <button class="btn btn-primary" id="completeBtn">–ì–æ—Ç–æ–≤–æ</button>
                <button class="btn btn-secondary" id="closeBtn">–ó–∞–∫—Ä–∏—Ç–∏</button>
            </div>
        </div>
    </div>


    <script>
        // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è Telegram Web App
        const tg = window.Telegram.WebApp;
        tg.expand();
        tg.ready();
        
        // –ö–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è - –∑–∞–º—ñ–Ω—ñ—Ç—å –Ω–∞ –≤–∞—à n8n webhook URL
        // const N8N_WEBHOOK_URL = 'https://f2beb0dcc8e9.ngrok-free.app/webhook-test/21792f71-6dd9-468e-b59c-5f01a49d2e9c';
        const N8N_WEBHOOK_URL = 'https://n8n.lobstrrrobert.org/webhook/21792f71-6dd9-468e-b59c-5f01a49d2e9c';
        
        let tasks = [];
        let currentTaskIndex = null;
        
        // –û—Ç—Ä–∏–º–∞–Ω–Ω—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –∑ Telegram
        const user = tg.initDataUnsafe?.user || { id: 'demo', first_name: 'Demo' };
        
        // –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∑–∞–≤–¥–∞–Ω—å –∑ n8n
        async function loadTasks() {
            try {
                const response = await fetch(N8N_WEBHOOK_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'get_tasks',
                        user_id: user.id,
                        user_name: user.username
                    })
                });
                
                if (!response.ok) {
                    throw new Error('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è');
                }
                
                const data = await response.json();
                tasks = getDefaultTasks();
                if (data.tasks) {
                    tasks.forEach(task => {
                        const serverTask = data.tasks.find(t => t.id === task.id);
                        if (serverTask) {
                            task.completed = serverTask.completed;
                        }
                    });
                }

                renderBingoGrid();
                
            } catch (error) {
                console.error('Error loading tasks:', error);
                // –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –¥–µ–º–æ –∑–∞–≤–¥–∞–Ω–Ω—è —è–∫—â–æ –Ω–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –∑ n8n
                tasks = getDefaultTasks();
                renderBingoGrid();
            }
        }
        // async function loadTasks() {
        //     try {
        //         // –í—ñ–¥–ø—Ä–∞–≤–ª—è—î–º–æ –∫–æ–º–∞–Ω–¥—É –±–æ—Ç—É —á–µ—Ä–µ–∑ Telegram Web App
        //         tg.sendData(JSON.stringify({
        //             action: 'get_tasks',
        //             user_id: user.id,
        //             user_name: user.first_name
        //         }));
                
        //         // –¢–∏–º—á–∞—Å–æ–≤–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –¥–µ–º–æ –¥–∞–Ω—ñ
        //         tasks = getDefaultTasks();
        //         renderBingoGrid();
                
        //     } catch (error) {
        //         console.error('Error loading tasks:', error);
        //         tasks = getDefaultTasks();
        //         renderBingoGrid();
        //     }
        // }
        
        // –î–µ—Ñ–æ–ª—Ç–Ω—ñ –∑–∞–≤–¥–∞–Ω–Ω—è –¥–ª—è –¥–µ–º–æ
        function getDefaultTasks() {
            return [
                { id: 1, title: "1.–ó–ª–æ–≤–∏ –º–æ–º–µ–Ω—Ç —â–∞—Å—Ç—è", description: "–ó—Ä–æ–±–∏ —Ñ–æ—Ç–æ –ª—é–¥–∏–Ω–∏, —è–∫–∞ —â–∏—Ä–æ —Å–º—ñ—î—Ç—å—Å—è", completed: false },
                { id: 2, title: "2.–ü–æ–≥–ª—è–¥ –∫–æ—Ö–∞–Ω–Ω—è", description: "–°—Ñ–æ—Ç–æ–≥—Ä–∞—Ñ—É–π –º–æ–º–µ–Ω—Ç, –∫–æ–ª–∏ —Ö—Ç–æ—Å—å –∑–∞–∫–æ—Ö–∞–Ω–æ –¥–∏–≤–∏—Ç—å—Å—è –Ω–∞ —ñ–Ω—à—É –ª—é–¥–∏–Ω—É", completed: false },
                { id: 3, title: "3.–°–µ–ª—Ñ—ñ –∑ –Ω–µ–∑–Ω–∞–π–æ–º—Ü–µ–º", description: "–ó—Ä–æ–±–∏ —Å–µ–ª—Ñ—ñ –∑ –≥–æ—Å—Ç–µ–º, —è–∫–æ–≥–æ —â–µ –Ω–µ –∑–Ω–∞–≤/–ª–∞ –¥–æ –≤–µ—Å—ñ–ª–ª—è", completed: false },
                { id: 4, title: "4.–í–µ—Å—ñ–ª–ª—è –æ—á–∏–º–∞ –¥–∏—Ç–∏–Ω–∏", description: "–ó—Ä–æ–±–∏ —Ñ–æ—Ç–æ –∑ –Ω–∞–π–Ω–µ–æ—á—ñ–∫—É–≤–∞–Ω—ñ—à–æ–≥–æ —Ä–∞–∫—É—Ä—Å—É (–∑–Ω–∏–∑—É, –∑-–ø—ñ–¥ —Å—Ç–æ–ª—É, —á–µ—Ä–µ–∑ –∫–µ–ª–∏—Ö)", completed: false },
                { id: 5, title: "5.–ü—ñ–¥–æ–∑—Ä—ñ–ª–æ —Å–º–∞—á–Ω–∏–π –º–æ–º–µ–Ω—Ç", description: "–°—Ñ–æ—Ç–æ–≥—Ä–∞—Ñ—É–π –∫–æ–≥–æ—Å—å, —Ö—Ç–æ –Ω–∞–¥—Ç–æ —â–∞—Å–ª–∏–≤–∏–π, –∫–æ–ª–∏ —ó—Å—Ç—å.", completed: false },
                { id: 6, title: "6.–Ø ‚Äî —Ç–≤–æ—è –¥–µ–∫–æ—Ä–∞—Ü—ñ—è", description: "–°—Ñ–æ—Ç–æ–≥—Ä–∞—Ñ—É–π –ª—é–¥–∏–Ω—É, —è–∫–∞ —ñ–¥–µ–∞–ª—å–Ω–æ –≤–ø–∏—Å–∞–ª–∞—Å—å —É —Ñ–æ–Ω/–¥–µ–∫–æ—Ä (–Ω–∞—á–µ –≤–æ–Ω–∞ —á–∞—Å—Ç–∏–Ω–∞ —ñ–Ω—Ç–µ—Ä‚Äô—î—Ä—É).", completed: false },
                { id: 7, title: "7.–í–µ—Å—ñ–ª—å–Ω–∏–π double", description: "–ó–Ω–∞–π–¥–∏ 2 –≥–æ—Å—Ç–µ–π –≤ –æ–¥–Ω–∞–∫–æ–≤–æ–º—É –∫–æ–ª—å–æ—Ä—ñ –æ–¥—è–≥—É –∞–±–æ —Å—Ö–æ–∂–æ–º—É –æ–±—Ä–∞–∑—ñ ‚Äî –∑—Ä–æ–±–∏ ‚Äú—Ñ–æ—Ç–æ-–±–ª–∏–∑–Ω—é–∫—ñ–≤‚Äù.", completed: false },
                { id: 8, title: "8.–ë–æ—Ö–æ-–¥–µ—Ç–∞–ª—å", description: "–ó–Ω–∞–π–¥–∏ –π —Å—Ñ–æ—Ç–æ–≥—Ä–∞—Ñ—É–π –Ω–∞–π–∫—Ä—É—Ç—ñ—à–∏–π –µ–ª–µ–º–µ–Ω—Ç –¥–µ–∫–æ—Ä—É (–ª–æ–≤–µ—Ü—å —Å–Ω—ñ–≤, –º–∞–∫—Ä–∞–º–µ, –ª–∞–º–ø–∞, –∫–≤—ñ—Ç–∫–∞, –¥–µ—Ç–∞–ª—å –Ω–∞ —Å—É–∫–Ω—ñ —Ç–æ—â–æ).", completed: false },
                { id: 9, title: "9.–ì—Ä—É–ø–æ–≤–µ —Ö–∞–æ—Å-—Å–µ–ª—Ñ—ñ", description: "–ó–±–µ—Ä–∏ 4+ –ª—é–¥–µ–π —ñ –∑—Ä–æ–±—ñ—Ç—å —è–∫–æ–º–æ–≥–∞ –∞–±—Å—É—Ä–¥–Ω—ñ—à–µ –∞–±–æ –¥–∏–≤–Ω—ñ—à–µ –≥—Ä—É–ø–æ–≤–µ —Å–µ–ª—Ñ—ñ (–µ–º–æ—Ü—ñ—ó, –ø–æ–∑–∏, –ø—Ä–µ–¥–º–µ—Ç–∏ ‚Äî —É—Å–µ –¥–æ–∑–≤–æ–ª–µ–Ω–æ).", completed: false }
            ];
        }
        
        
        // –í—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è —Å—ñ—Ç–∫–∏ –±—ñ–Ω–≥–æ
        function renderBingoGrid() {
            const grid = document.getElementById('bingoGrid');
            const container = document.getElementById('bingo-container');
            const loading = document.getElementById('loading');
            
            grid.innerHTML = '';
            
            tasks.forEach((task, index) => {
                const cell = document.createElement('button');
                cell.className = `bingo-cell ${task.completed ? 'completed' : ''}`;
                cell.textContent = task.title;
                cell.onclick = () => openTaskModal(index);
                grid.appendChild(cell);
            });
            
            loading.style.display = 'none';
            container.style.display = 'block';
        }
        
        // –í—ñ–¥–∫—Ä–∏—Ç—Ç—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –≤—ñ–∫–Ω–∞
        function openTaskModal(taskIndex) {
            currentTaskIndex = taskIndex;
            const task = tasks[taskIndex];
            
            document.getElementById('modalTitle').textContent = task.title;
            document.getElementById('modalDescription').textContent = task.description;
            document.getElementById('modal').style.display = 'block';
            
            const completeBtn = document.getElementById('completeBtn');
            completeBtn.textContent = task.completed ? '–°–∫–∞—Å—É–≤–∞—Ç–∏' : '–ì–æ—Ç–æ–≤–æ';
            completeBtn.onclick = toggleTaskComplete;
        }
        
        // –ó–∞–∫—Ä–∏—Ç—Ç—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –≤—ñ–∫–Ω–∞
        function closeModal() {
            document.getElementById('modal').style.display = 'none';
            currentTaskIndex = null;
        }
        
        // –ü–µ—Ä–µ–º–∏–∫–∞–Ω–Ω—è —Å—Ç–∞—Ç—É—Å—É –∑–∞–≤–¥–∞–Ω–Ω—è
        async function toggleTaskComplete() {
            if (currentTaskIndex === null) return;
            
            const task = tasks[currentTaskIndex];
            
            // –Ø–∫—â–æ –∑–∞–≤–¥–∞–Ω–Ω—è —â–µ –Ω–µ –≤–∏–∫–æ–Ω–∞–Ω–æ - –ø—Ä–æ–ø–æ–Ω—É—î–º–æ –∑—Ä–æ–±–∏—Ç–∏ —Ñ–æ—Ç–æ
            if (!task.completed) {
                // –ó–∞–∫—Ä–∏–≤–∞—î–º–æ –º–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ
                closeModal();
                requestPhoto(task)
            } else {
                // –Ø–∫—â–æ –∑–∞–≤–¥–∞–Ω–Ω—è –≤–∂–µ –≤–∏–∫–æ–Ω–∞–Ω–æ - —Å–∫–∞—Å–æ–≤—É—î–º–æ –π–æ–≥–æ
                task.completed = false;
                await updateTaskStatus(task);
                renderBingoGrid();
                closeModal();
            }
        }
        
        // –ó–∞–ø–∏—Ç –Ω–∞ —Ñ–æ—Ç–æ —á–µ—Ä–µ–∑ Telegram Web App (—Å–ø—Ä–æ—â–µ–Ω–∏–π)
        function requestPhoto(task) {
            tg.showPopup({
                title: "–î–æ–¥–∞—Ç–∏ —Ñ–æ—Ç–æ",
                message: `–Ø–∫ –¥–æ–¥–∞—Ç–∏ —Ñ–æ—Ç–æ –¥–ª—è –∑–∞–≤–¥–∞–Ω–Ω—è "${task.title}"?`,
                buttons: [
                    {id: "gallery", type: "default", text: "üñºÔ∏è –í–∏–±—Ä–∞—Ç–∏ –∑ –≥–∞–ª–µ—Ä–µ—ó"},
                    {id: "cancel", type: "cancel", text: "–°–∫–∞—Å—É–≤–∞—Ç–∏"}
                ]
            }, (buttonId) => {
                // if (buttonId === "1") {
                //     openCamera(task);
                // } else 
                if (buttonId === "gallery") {
                    openGallery(task);
                }
            });
        }

        // –í—ñ–¥–∫—Ä–∏—Ç—Ç—è –∫–∞–º–µ—Ä–∏ (–∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –ø—ñ—Å–ª—è –≤–∏–±–æ—Ä—É)
        function openCamera(task) {
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = 'image/*';
            fileInput.capture = 'camera';
            
            fileInput.onchange = async (event) => {
                const file = event.target.files[0];
                if (file) {
                    await handlePhotoUpload(task, file);
                }
            };
            
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –≤—ñ–¥–∫—Ä–∏–≤–∞—î–º–æ
            fileInput.click();
        }

        // –í—ñ–¥–∫—Ä–∏—Ç—Ç—è –≥–∞–ª–µ—Ä–µ—ó (–∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –ø—ñ—Å–ª—è –≤–∏–±–æ—Ä—É)
        function openGallery(task) {
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = 'image/*';
            
            fileInput.onchange = async (event) => {
                const file = event.target.files[0];
                if (file) {
                    await handlePhotoUpload(task, file);
                }
            };
            
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –≤—ñ–¥–∫—Ä–∏–≤–∞—î–º–æ
            fileInput.click();
        }
        
        // –û–±—Ä–æ–±–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ñ–æ—Ç–æ (–±–µ–∑ –≥–æ–ª–æ–≤–Ω–æ—ó –∫–Ω–æ–ø–∫–∏)
        async function handlePhotoUpload(task, file) {
            try {
                // –ü–æ–∫–∞–∑—É—î–º–æ —Ç–æ—Å—Ç –∑–∞–º—ñ—Å—Ç—å –∫–Ω–æ–ø–∫–∏
                tg.showAlert("üì§ –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ñ–æ—Ç–æ...");
                
                // –ö–æ–Ω–≤–µ—Ä—Ç—É—î–º–æ —Ñ–∞–π–ª –≤ base64 –¥–ª—è –≤—ñ–¥–ø—Ä–∞–≤–∫–∏
                const base64Photo = await fileToBase64(file);
                
                // –ü–æ–∑–Ω–∞—á–∞—î–º–æ –∑–∞–≤–¥–∞–Ω–Ω—è —è–∫ –≤–∏–∫–æ–Ω–∞–Ω–µ
                // task.completed = true;
                
                // –í—ñ–¥–ø—Ä–∞–≤–ª—è—î–º–æ –¥–∞–Ω—ñ –∑ —Ñ–æ—Ç–æ –≤ n8n
                const response = await fetch(N8N_WEBHOOK_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'update_task_with_photo',
                        user_id: user.id,
                        user_name: user.username,
                        task_id: task.id,
                        completed: task.completed,
                        photo: base64Photo,
                        photo_name: `task_${task.id}_${user.id}_${Date.now()}.jpg`,
                        timestamp: new Date().toISOString()
                    })
                });

                if (!response.ok) {
                    throw new Error('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è');
                }
                const data = await response.json();
                if (data.tasks) {
                    const serverTask = data.tasks.find(t => t.id === task.id);
                        if (serverTask) {
                            task.completed = serverTask.completed;
                        }
                }

                
                // –û–Ω–æ–≤–ª—é—î–º–æ —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å
                renderBingoGrid();
                
                // –ü–æ–∫–∞–∑—É—î–º–æ —É—Å–ø—ñ—Ö
                tg.showAlert(`–§–æ—Ç–æ –¥–ª—è –∑–∞–≤–¥–∞–Ω–Ω—è "${task.title}" —É—Å–ø—ñ—à–Ω–æ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ! üéâ`);
                tg.HapticFeedback.notificationOccurred('success');
                
            } catch (error) {
                console.error('Error uploading photo:', error);
                task.completed = false;
                tg.showAlert('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ñ–æ—Ç–æ. –°–ø—Ä–æ–±—É–π—Ç–µ —â–µ —Ä–∞–∑.');
                tg.HapticFeedback.notificationOccurred('error');
            }
        }
        
        // –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü—ñ—è —Ñ–∞–π–ª—É –≤ base64
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            });
        }
        
        // –û–Ω–æ–≤–ª–µ–Ω–Ω—è —Å—Ç–∞—Ç—É—Å—É –∑–∞–≤–¥–∞–Ω–Ω—è (–±–µ–∑ —Ñ–æ—Ç–æ)
        async function updateTaskStatus(task) {
            try {
                await fetch(N8N_WEBHOOK_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'update_task',
                        user_id: user.id,
                        task_id: task.id,
                        completed: task.completed
                    })
                });
            } catch (error) {
                console.error('Error updating task:', error);
            }
        }
        
        // –û–±—Ä–æ–±–∫–∞ –ø–æ–¥—ñ–π
        document.getElementById('closeBtn').onclick = closeModal;
        
        // –ó–∞–∫—Ä–∏—Ç—Ç—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –≤—ñ–∫–Ω–∞ –ø—Ä–∏ –∫–ª—ñ–∫—É –ø–æ–∑–∞ –Ω–∏–º
        document.getElementById('modal').onclick = function(e) {
            if (e.target === this) {
                closeModal();
            }
        };
        
        // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è
        loadTasks();
        
        // –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è Telegram –∫–Ω–æ–ø–æ–∫
        tg.MainButton.setText("üì∑ –û–Ω–æ–≤–∏—Ç–∏ –∑–∞–≤–¥–∞–Ω–Ω—è");
        tg.MainButton.onClick(loadTasks);
        tg.MainButton.show();
    </script>
</body>
</html>
